<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>WebSocket 笔记 | Quan Blogs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="wuquan" >
    <meta name="description" content="Quan个人前端小站" >

    
    <link rel="alternative" href="/atom.xml" title="Quan Blogs" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="/favicon.ico" >
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?fd459238242776d173cdc64918fb32f2";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


    
</head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">Quan Blogs</span>
                    <span class="description">Quan</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/2017/06/18/Websocket Summarize/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/2017/06/18/Websocket Summarize/index.html" class="item ">
                <a href="/lab/" title="计划" class="icon-lab">&nbsp;计划</a>
            </li>
            
            <li rel="/2017/06/18/Websocket Summarize/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/2017/06/18/Websocket Summarize/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="“#”" target="_blank">Coding</a>
                        |
                    
                        <a href="#" target="_blank">Github</a>
                        |
                    
                        <a href="#" target="_blank">百度统计</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com/" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_quan.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span>WebSocket 笔记</span></h3>
    </header>
    <p class="post-meta text-center">
        Quan 发表于
        <time datetime="2017-06-18T06:11:25.354Z">2017-06-18</time>
    </p>
    <div class="post-content">
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>  Websocket是html5提出的一个协议规范，参考rfc6455.</p>
<p>  Websocket约定了一个通信的规范，通过一个握手的机制，客户端（浏览器）和服务器（webserver）之间能建立一个类似tcp的连接，从而方便c－s之间的通信。在websocket出现之前，web交互一般是基于http协议的短连接或者长连接。</p>
<a id="more"></a>
<p>​  WebSocket是为解决客户端与服务端实时通信而产生的技术。websocket协议本质上是一个基于tcp的协议，是先通过HTTP/HTTPS协议发起一条特殊的http请求进行握手后创建一个用于交换数据的TCP连接，此后服务端与客户端通过此TCP连接进行实时通信。</p>
<h3 id="1-Websocket协议规范"><a href="#1-Websocket协议规范" class="headerlink" title="1. Websocket协议规范"></a>1. Websocket协议规范</h3><p>  <strong>a. 握手规范 </strong></p>
<p>  websocket 是 独立的基于TCP的协议， 其跟http协议的关系仅仅是 WebSocket 的握手被http 服务器当做 Upgrade request http包处理。 websocket 有自己的握手处理。 TCP连接建立后，client 发送websocket 握手请求. </p>
<blockquote>
<p>请求格式如下:</p>
</blockquote>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /path/to/websocket/endpoint HTTP/1.1</div><div class="line">Host: localhost</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Key: xqBt3ImNzJbYqRINxEFlkg==</div><div class="line">Origin: http://localhost</div><div class="line">Sec-WebSocket-Version: 13</div></pre></td></tr></table></figure>
<blockquote>
<p>一个简单response</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 101 Switching Protocols</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Accept: K7DJLdLooIwIG/MOpvWFB3y3FE8=</div></pre></td></tr></table></figure>
<p>  握手规范:</p>
<ul>
<li><p>有效的http request请求格式，而且Http request method必须是GET，协议版本不小于1.1，如: Get /chat HTTP/1.1 。</p>
</li>
<li><p>必须包括’Connection’头域，其值为 “Upgrade”，指示服务器升级连接。</p>
</li>
<li><p>必须包括’Upgrade’头域，并且其值为 “websocket”，指示服务升级为websocket服务。</p>
</li>
<li><p>必须包括’Sec-WebSocket-Key’，其值采用base64编码的随机16字节长的字符序列， 服务器端根据该域来判断client 确实是websocket请求而不是冒充的，如http。响应方式是，首先要获取到请求头中的Sec-WebSocket-Key的值，再把这一段GUID “258EAFA5-E914-47DA-95CA-C5AB0DC85B11”加到获取到的Sec-WebSocket-Key的值的后面，然后拿这个字符串做SHA-1 hash计算，然后再把得到的结果通过base64加密，就得到了返回给客户端的Sec-WebSocket-Accept的http响应头的值。</p>
</li>
<li><p>如果请求来自浏览器客户端，还必须包括Origin头域 。 该头域用于防止未授权的跨域脚本攻击，服务器可以从Origin决定是否接受该WebSocket连接。</p>
</li>
<li><p>必须包括”Sec-webSocket-Version” 头域，当前值必须是13。</p>
</li>
<li><p>可能包括”Sec-WebSocket-Protocol”，表示client（应用程序）支持的协议列表，server选择一个或者没有可接受的协议响应之。</p>
</li>
<li><p>可能包括”Sec-WebSocket-Extensions”， 协议扩展， 某类协议可能支持多个扩展，通过它可以实现协议增强。</p>
</li>
</ul>
<p><strong>b.传输协议 </strong></p>
<blockquote>
<p>TODO</p>
</blockquote>
<h3 id="2-Websocket-Api-规范（Java-EE-Chapter-18-Websocket-API）"><a href="#2-Websocket-Api-规范（Java-EE-Chapter-18-Websocket-API）" class="headerlink" title="2. Websocket Api 规范（Java EE Chapter 18 Websocket API）"></a>2. Websocket Api 规范（Java EE Chapter 18 Websocket API）</h3><blockquote>
<p>参考  <a href="https://docs.oracle.com/javaee/7/tutorial/websocket.htm#GKJIQ5" target="_blank" rel="external">https://docs.oracle.com/javaee/7/tutorial/websocket.htm#GKJIQ5</a></p>
</blockquote>
<h3 id="3-Run-Demo-结合Logback-实现页面实时显示日志信息"><a href="#3-Run-Demo-结合Logback-实现页面实时显示日志信息" class="headerlink" title="3. Run Demo: 结合Logback 实现页面实时显示日志信息"></a>3. Run Demo: 结合Logback 实现页面实时显示日志信息</h3><blockquote>
<p>Websocket Endpoint</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.websocket.CloseReason;</div><div class="line"><span class="keyword">import</span> javax.websocket.Endpoint;</div><div class="line"><span class="keyword">import</span> javax.websocket.EndpointConfig;</div><div class="line"><span class="keyword">import</span> javax.websocket.Session;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.function.Predicate;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by xiaoquan on 17-6-16.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DmxLogServerEndpoint</span> <span class="keyword">extends</span> <span class="title">Endpoint</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger LOG = LoggerFactory.getLogger(DmxLogServerEndpoint.class);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_PATH_LOG_NAME = <span class="string">"loggerName"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Predicate&lt;String&gt; IS_BLANK = (k) -&gt; k == <span class="keyword">null</span> || k.trim().length() == <span class="number">0</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> DmxLogWebSocketPipe pipe = DmxLogWebSocketPipe.getInstance();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            session.getPathParameters().forEach((k, v) -&gt; System.out.println(k + <span class="string">":"</span> + v));</div><div class="line"></div><div class="line">            String loggerName = session.getPathParameters().get(REQUEST_PATH_LOG_NAME);</div><div class="line">            <span class="keyword">if</span> (IS_BLANK.test(loggerName)) &#123;</div><div class="line">                session.close(<span class="keyword">new</span> CloseReason(CloseReason.CloseCodes.UNEXPECTED_CONDITION, <span class="string">"Not found logger name"</span>));</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            LOG.debug(<span class="string">"Registe session: [logger:&#123;&#125;, session:&#123;&#125;]"</span>, loggerName, session.getId());</div><div class="line">            pipe.register(loggerName, session);</div><div class="line">            session.getBasicRemote().sendText(<span class="string">"Server connect success."</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> </span>&#123;</div><div class="line">        cancelFromPipe(session);</div><div class="line">        <span class="keyword">super</span>.onClose(session, closeReason);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session, Throwable throwable)</span> </span>&#123;</div><div class="line">        cancelFromPipe(session);</div><div class="line">        <span class="keyword">super</span>.onError(session, throwable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelFromPipe</span><span class="params">(Session session)</span> </span>&#123;</div><div class="line">        String loggerName = session.getPathParameters().get(REQUEST_PATH_LOG_NAME);</div><div class="line">        <span class="keyword">if</span> (IS_BLANK.test(loggerName)) &#123;</div><div class="line">            pipe.cancel(session);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            pipe.cancel(loggerName, session);</div><div class="line">        &#125;</div><div class="line">        LOG.debug(<span class="string">"cancel from pipe: [logger:&#123;&#125;, session:&#123;&#125;]"</span>, loggerName, session.getId());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Logback Appender</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DmxAppender</span> <span class="keyword">extends</span> <span class="title">UnsynchronizedAppenderBase</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DmxLogWebSocketPipe pipe = DmxLogWebSocketPipe.getInstance();</div><div class="line">    <span class="keyword">protected</span> Encoder&lt;ILoggingEvent&gt; encoder;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(ILoggingEvent eventObject)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes = encoder.encode(eventObject);</div><div class="line">        pipe.write(eventObject.getLoggerName(), bytes);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLayout</span><span class="params">(Layout&lt;ILoggingEvent&gt; layout)</span> </span>&#123;</div><div class="line">        addWarn(<span class="string">"This appender no longer admits a layout as a sub-component, set an encoder instead."</span>);</div><div class="line">        addWarn(<span class="string">"To ensure compatibility, wrapping your layout in LayoutWrappingEncoder."</span>);</div><div class="line">        addWarn(<span class="string">"See also "</span> + CODES_URL + <span class="string">"#layoutInsteadOfEncoder for details"</span>);</div><div class="line">        LayoutWrappingEncoder&lt;ILoggingEvent&gt; lwe = <span class="keyword">new</span> LayoutWrappingEncoder&lt;ILoggingEvent&gt;();</div><div class="line">        lwe.setLayout(layout);</div><div class="line">        lwe.setContext(context);</div><div class="line">        <span class="keyword">this</span>.encoder = lwe;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEncoder</span><span class="params">(Encoder&lt;ILoggingEvent&gt; encoder)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.encoder = encoder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>一个绑定日志和WebSocket Session的管道，负责把消息发送到页面</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DmxLogWebSocketPipe</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(DmxLogWebSocketPipe.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Set&lt;Session&gt;&gt; sessionMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ReentrantReadWriteLock readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line">    <span class="keyword">private</span> Lock readeLock = readWriteLock.readLock();</div><div class="line">    <span class="keyword">private</span> Lock writeLock = readWriteLock.writeLock();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DmxLogWebSocketPipe</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String loggerName, Session session)</span> </span>&#123;</div><div class="line">        executeWithLock(writeLock, () -&gt; &#123;</div><div class="line">            Set&lt;Session&gt; sessions = sessionMap.computeIfAbsent(loggerName, key -&gt; <span class="keyword">new</span> HashSet&lt;&gt;());</div><div class="line">            sessions.add(session);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">(String loggerName, Session session)</span> </span>&#123;</div><div class="line">        executeWithLock(writeLock, () -&gt; &#123;</div><div class="line">            Set&lt;Session&gt; sessions = sessionMap.get(loggerName);</div><div class="line">            <span class="keyword">if</span> (sessions == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            sessions.remove(session);</div><div class="line">            <span class="keyword">if</span> (sessions.isEmpty()) &#123;</div><div class="line">                sessionMap.remove(loggerName);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">(Session session)</span> </span>&#123;</div><div class="line">        executeWithLock(writeLock, () -&gt; &#123;</div><div class="line">            Iterator&lt;Map.Entry&lt;String, Set&lt;Session&gt;&gt;&gt; it = sessionMap.entrySet().iterator();</div><div class="line">            <span class="keyword">for</span> (; it.hasNext(); ) &#123;</div><div class="line">                Set&lt;Session&gt; sessions = it.next().getValue();</div><div class="line">                sessions.remove(session);</div><div class="line">                <span class="keyword">if</span> (sessions.isEmpty()) &#123;</div><div class="line">                    it.remove();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String loggerName, <span class="keyword">byte</span>[] message)</span> </span>&#123;</div><div class="line">        executeWithLock(readeLock, () -&gt; &#123;</div><div class="line">            <span class="keyword">if</span> (sessionMap.containsKey(loggerName)) &#123;</div><div class="line">                sessionMap.get(loggerName).forEach(session -&gt; &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">//if client not close correctly, the session may be invalid</span></div><div class="line">                        <span class="keyword">if</span> (session.isOpen()) &#123;</div><div class="line">                            session.getBasicRemote().sendText(<span class="keyword">new</span> String(message));</div><div class="line"><span class="comment">//                            session.getBasicRemote().sendBinary(ByteBuffer.wrap(message));</span></div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        <span class="keyword">if</span> (!session.isOpen()) &#123;</div><div class="line">                            LOGGER.info(<span class="string">"session had been closed."</span>);</div><div class="line">                        &#125;</div><div class="line">                        LOGGER.error(<span class="string">"Unkown error: "</span> + e.getMessage());</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCloseSession</span><span class="params">()</span> </span>&#123;</div><div class="line">        executeWithLock(writeLock, () -&gt; &#123;</div><div class="line">            Iterator&lt;Map.Entry&lt;String, Set&lt;Session&gt;&gt;&gt; it = sessionMap.entrySet().iterator();</div><div class="line">            <span class="keyword">for</span> (; it.hasNext(); ) &#123;</div><div class="line">                Map.Entry&lt;String, Set&lt;Session&gt;&gt; entry = it.next();</div><div class="line">                Set&lt;Session&gt; sessions = Optional.ofNullable(entry.getValue()).orElse(<span class="keyword">new</span> HashSet&lt;&gt;());</div><div class="line">                Iterator&lt;Session&gt; sessionIterator = sessions.iterator();</div><div class="line">                <span class="keyword">for</span> (; sessionIterator.hasNext(); ) &#123;</div><div class="line">                    Session session = sessionIterator.next();</div><div class="line">                    <span class="keyword">if</span> (!session.isOpen()) &#123;</div><div class="line">                        sessionIterator.remove();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (sessions.isEmpty()) &#123;</div><div class="line">                    it.remove();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeWithLock</span><span class="params">(Lock lock, Runnable func)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            lock.lock();</div><div class="line">            func.run();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DmxLogWebSocketPipe pipe = <span class="keyword">new</span> DmxLogWebSocketPipe();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DmxLogWebSocketPipe <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pipe;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Server Config: 通过该类来过滤和配置Endpoint</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExamplesConfig</span> <span class="keyword">implements</span> <span class="title">ServerApplicationConfig</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ServerEndpointConfig&gt; <span class="title">getEndpointConfigs</span><span class="params">(Set&lt;Class&lt;? extends Endpoint&gt;&gt; scanned)</span> </span>&#123;</div><div class="line">        Set&lt;ServerEndpointConfig&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        ServerEndpointConfig config = ServerEndpointConfig.Builder.create(DmxLogServerEndpoint.class, <span class="string">"/dmxlog/&#123;loggerName&#125;"</span>).build();</div><div class="line">        result.add(config);</div><div class="line">        <span class="comment">/*if (scanned.contains(EchoEndpoint.class)) &#123;</span></div><div class="line">            result.add(ServerEndpointConfig.Builder.create(</div><div class="line">                    EchoEndpoint.class,</div><div class="line">                    "/websocket/echoProgrammatic").build());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (scanned.contains(DrawboardEndpoint.class)) &#123;</div><div class="line">            result.add(ServerEndpointConfig.Builder.create(</div><div class="line">                    DrawboardEndpoint.class,</div><div class="line">                    "/websocket/drawboard").build());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println("load servr endpoint config:" + scanned.size());</div><div class="line"></div><div class="line">*/</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Set&lt;Class&lt;?&gt;&gt; getAnnotatedEndpointClasses(Set&lt;Class&lt;?&gt;&gt; scanned) &#123;</div><div class="line">        <span class="comment">// Deploy all WebSocket endpoints defined by annotations in the examples</span></div><div class="line">        <span class="comment">// web application. Filter out all others to avoid issues when running</span></div><div class="line">        <span class="comment">// tests on Gump</span></div><div class="line">        Set&lt;Class&lt;?&gt;&gt; results = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"><span class="comment">//        for (Class&lt;?&gt; clazz : scanned) &#123;</span></div><div class="line"><span class="comment">//            if (clazz.getPackage().getName().startsWith("com.traitswu.")) &#123;</span></div><div class="line"><span class="comment">//                results.add(clazz);</span></div><div class="line"><span class="comment">//            &#125;</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line"><span class="comment">//        System.out.println("load Annotated servr endpoint config:" + scanned.size());</span></div><div class="line"><span class="comment">//        results.forEach(r -&gt; System.out.println(r.getName()));</span></div><div class="line"></div><div class="line"><span class="comment">//        results.add(DmxLogEndpoint.class);</span></div><div class="line">        <span class="keyword">return</span> results;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>其他</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebListener</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServletContextListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ScheduledFuture&lt;?&gt; future;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ScheduledExecutorService scriptSchedule = Executors.newSingleThreadScheduledExecutor();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        future = scriptSchedule.scheduleWithFixedDelay(() -&gt; &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ScriptExecuteUtils.eval(<span class="string">"action1"</span>, <span class="keyword">new</span> HashMap&lt;&gt;());</div><div class="line">                ScriptExecuteUtils.eval(<span class="string">"action2"</span>, <span class="keyword">new</span> HashMap&lt;&gt;());</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="number">5</span>, <span class="number">5</span> , TimeUnit.SECONDS);</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"MyServletContextListener init"</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (future != <span class="keyword">null</span>) &#123;</div><div class="line">            future.cancel(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">        scriptSchedule.shutdown();</div><div class="line">        System.out.println(<span class="string">"MyServletContextListener destory"</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptExecuteUtils</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, CompiledScript&gt; scripts = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">loadScript</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        InputStream stream = ScriptExecuteUtils.class.getClassLoader().getResourceAsStream(path);</div><div class="line">        <span class="keyword">return</span> IOUtils.toString(stream, Charset.forName(<span class="string">"UTF-8"</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String script1 = loadScript(<span class="string">"action1.groovy"</span>);</div><div class="line">            String script2 = loadScript(<span class="string">"action2.groovy"</span>);</div><div class="line"></div><div class="line">            ScriptEngineManager manager = <span class="keyword">new</span> ScriptEngineManager();</div><div class="line">            ScriptEngine engine = manager.getEngineByName(<span class="string">"groovy"</span>);</div><div class="line"></div><div class="line">            CompiledScript compiledScript1 = ((Compilable) engine).compile(script1);</div><div class="line">            CompiledScript compiledScript2 = ((Compilable) engine).compile(script2);</div><div class="line"></div><div class="line">            scripts.put(<span class="string">"action1"</span>, compiledScript1);</div><div class="line">            scripts.put(<span class="string">"action2"</span>, compiledScript2);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">eval</span><span class="params">(String scriptId, Map&lt;String, Object&gt; params)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        SimpleBindings bindings = <span class="keyword">new</span> SimpleBindings();</div><div class="line">        bindings.putAll(params);</div><div class="line">        <span class="keyword">return</span> scripts.get(scriptId).eval(bindings);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>action1.groovy</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Logger logger = LoggerFactory.getLogger(<span class="string">"dmxLog.action1"</span>)</div><div class="line">(<span class="number">1.</span><span class="number">.5</span>).each &#123; i -&gt;</div><div class="line">    Thread.currentThread().sleep(<span class="number">500</span>L)</div><div class="line">    logger.info(<span class="string">"[action1] hello world:"</span> + i)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>action2.groovy</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Logger logger = LoggerFactory.getLogger(<span class="string">"dmxLog.action2"</span>)</div><div class="line"></div><div class="line">(<span class="number">1.</span><span class="number">.5</span>).each &#123; i -&gt;</div><div class="line">    Thread.currentThread().sleep(<span class="number">500</span>L)</div><div class="line">    logger.info(<span class="string">"[action2] welcome:"</span> + i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>logback.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span></span></div><div class="line">              <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></div><div class="line">                %d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg [xiaoquan]%n</div><div class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT-xiaoquan"</span> <span class="attr">class</span>=<span class="string">"com.traitswu.websocket.dmxlog.core.DmxAppender"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></div><div class="line">                %d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg [xiaoquan-dmx]%n</div><div class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.traitswu.websocket"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"dmxLog"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT-xiaoquan"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>test pager</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>simple-websocket-test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="xml"></span></div><div class="line">        console.info('hello:' + window.location.host);</div><div class="line">        function onOpen(data) &#123;</div><div class="line">            console.log('===onOpen====')</div><div class="line">            console.log(data)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function onMessage(message) &#123;</div><div class="line">            console.info('===onMessage====')</div><div class="line">            var contentDiv = document.getElementById("content");</div><div class="line">            var pEle = document.createElement("pre");</div><div class="line">            var pTextNode = document.createTextNode(message.data + '');</div><div class="line">            pEle.appendChild(pTextNode);</div><div class="line">            contentDiv.appendChild(pEle);</div><div class="line">        &#125;</div><div class="line">        function onClose(data) &#123;</div><div class="line">            console.log('===onClose====')</div><div class="line">            console.log(data)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function onErr(data) &#123;</div><div class="line">            console.log('===onErr====')</div><div class="line">            console.log(data)</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        var socketServer;</div><div class="line">        function connect(hostxxx) &#123;</div><div class="line">            close1(socketServer);</div><div class="line"></div><div class="line">            var contentDiv = document.getElementById("content");</div><div class="line"></div><div class="line">            for (var i = 0; i <span class="tag">&lt; <span class="attr">contentDiv.childNodes.length</span>; <span class="attr">i</span>++) &#123;</span></div><div class="line">                <span class="attr">var</span> <span class="attr">node</span> = <span class="string">contentDiv.childNodes[i];</span></div><div class="line">                <span class="attr">contentDiv.removeChild</span>(<span class="attr">node</span>);</div><div class="line">                <span class="attr">node</span> = <span class="string">null;</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="attr">var</span> <span class="attr">val</span> = <span class="string">document.getElementById(</span>"<span class="attr">input</span>")<span class="attr">.value</span>;</div><div class="line"></div><div class="line">            <span class="attr">var</span> <span class="attr">host</span> = <span class="string">'ws://'</span> + <span class="attr">window.location.host</span> + '/<span class="attr">test-websocket</span>/<span class="attr">dmxlog</span>/' + <span class="attr">val</span>;</div><div class="line">            <span class="attr">console.log</span>(<span class="attr">host</span>);</div><div class="line"></div><div class="line">            <span class="attr">if</span> ('<span class="attr">WebSocket</span>' <span class="attr">in</span> <span class="attr">window</span>) &#123;</div><div class="line">                <span class="attr">socketServer</span> = <span class="string">new</span> <span class="attr">WebSocket</span>(<span class="attr">host</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="attr">if</span> ('<span class="attr">MozWebSocket</span>' <span class="attr">in</span> <span class="attr">window</span>) &#123;</div><div class="line">                <span class="attr">socketServer</span> = <span class="string">new</span> <span class="attr">MozWebSocket</span>(<span class="attr">host</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="attr">if</span> (<span class="attr">typeof</span>(<span class="attr">socketServer</span>) === <span class="string">undefined)</span> &#123;</div><div class="line">                <span class="attr">alert</span>('<span class="attr">not</span> <span class="attr">support</span>');</div><div class="line">                <span class="attr">return</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="attr">console.log</span>(<span class="attr">socketServer</span>);</div><div class="line"></div><div class="line">            <span class="attr">socketServer.onopen</span> = <span class="string">onOpen;</span></div><div class="line">            <span class="attr">socketServer.onmessage</span> = <span class="string">onMessage;</span></div><div class="line">            <span class="attr">socketServer.onerror</span> = <span class="string">onErr;</span></div><div class="line">            <span class="attr">socketServer.onclose</span> = <span class="string">onClose</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="attr">function</span> <span class="attr">send</span>() &#123;</div><div class="line">            <span class="attr">var</span> <span class="attr">val</span> = <span class="string">document.getElementById(</span>"<span class="attr">input</span>")<span class="attr">.value</span>;</div><div class="line">            <span class="attr">console.log</span>('<span class="attr">send:</span>' + <span class="attr">val</span>);</div><div class="line">            <span class="attr">socketServer.send</span>(<span class="attr">val</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="attr">function</span> <span class="attr">close1</span>(<span class="attr">socketServer</span>) &#123;</div><div class="line">            <span class="attr">if</span> (<span class="attr">socketServer</span> != <span class="string">null)</span> &#123;</div><div class="line">                <span class="attr">socketServer.close</span>();</div><div class="line">                <span class="attr">socketServer</span> = <span class="string">null;</span></div><div class="line">                <span class="attr">console.log</span>("<span class="attr">close</span> <span class="attr">socketserver</span> <span class="attr">manually</span>")</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"border: 1px solid royalblue; width: auto; background: #CCCCCC"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">H3</span>&gt;</span>TEST Hello world!!!!<span class="tag">&lt;/<span class="name">H3</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"input"</span> <span class="attr">value</span>=<span class="string">'dmxLog.action1'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">name</span>=<span class="string">"send"</span> <span class="attr">style</span>=<span class="string">"height: 30px;"</span> <span class="attr">onclick</span>=<span class="string">"connect(null)"</span>&gt;</span>Connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>

    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            <a class="cat-link" href="/categories/WebSocket/">WebSocket</a>
        </span>
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/webscoket/" title="webscoket">webscoket</a>
    

        </span>
    </p>
</article>
<div class="article-share clearfix text-center">
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</div>

<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br >
        <a href="/2017/06/21/Websocket_tomcat_read/">
            
                WebSocket Tomcat实现
            
        </a>
    </span>
    

    
    <span class="next fr">
        下一篇<br >
        <a href="/2017/06/17/Mybatis summarize/">
            
                MyBatis 简介
            
        </a>
    </span>
    
</div>

<!-- 文章评论 -->

            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/WebSocket/">WebSocket</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/MyBatis/">MyBatis</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/webscoket/" title="webscoket">webscoket (2)</a>
  
    <a class="tag-item" href="/tags/Mybatis-入门/" title="Mybatis 入门">Mybatis 入门 (1)</a>
  
</div>
    </section>
    

    
    <!-- 我的微博 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>我的微博</strong></h3>
        <div class="widget-bd" style="position: relative;">
  <div id="myWeiboLoading" class="text-center" style="position:absolute;top:0;left:0;right:0;bottom:0;line-height:50px;font-size:12px;background-color:#fff;z-index:9;">微博加载中...</div>
  <iframe id="myWeibo" width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=4&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=2433664154&verifier=66842d60&dpc=1"></iframe>
  <script>
  (function () {
    var oMyWeibo = document.getElementById('myWeibo');
    var oMyWeiboLoading = document.getElementById('myWeiboLoading');
    var isIE = /msie/i.test(navigator.userAgent) && !window.opera;
    var timer = null;
    if (isIE) {
      oMyWeibo.onreadystatechange = function(){
        if(oMyWeibo.readyState === 'loaded' || oMyWeibo.readyState === 'complete'){
          timer = setTimeout(function () {
            oMyWeiboLoading.parentNode.removeChild(oMyWeiboLoading);
            timer = null;
          }, 300);
        }
      };
    } else {
      oMyWeibo.onload = function () {
        timer = setTimeout(function () {
          oMyWeiboLoading.parentNode.removeChild(oMyWeiboLoading);
          timer = null;
        }, 300);
      };
    }
  })();
  </script>
</div>
    </section>
    

    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2017
    

    <a href="/">鄂ICP备15016859号-1</a>
    
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>
<!-- 添加百度自动推送 -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>

</body>
</html>