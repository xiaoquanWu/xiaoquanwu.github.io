<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>Tomcat WebSocket初始化 | Quan Blogs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="wuquan" >
    <meta name="description" content="Quan个人前端小站" >

    
    <link rel="alternative" href="/atom.xml" title="Quan Blogs" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="/favicon.ico" >
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?fd459238242776d173cdc64918fb32f2";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


    
</head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">Quan Blogs</span>
                    <span class="description">Quan</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/lab/" title="计划" class="icon-lab">&nbsp;计划</a>
            </li>
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="“#”" target="_blank">Coding</a>
                        |
                    
                        <a href="#" target="_blank">Github</a>
                        |
                    
                        <a href="#" target="_blank">百度统计</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com/" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_quan.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span>Tomcat WebSocket初始化</span></h3>
    </header>
    <p class="post-meta text-center">
        Quan 发表于
        <time datetime="2017-06-21T09:05:10.400Z">2017-06-21</time>
    </p>
    <div class="post-content">
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Tomcat8真正支持jsr-356(包含对websocket的支持)， tomcat7部分版本的websocket实现不兼容jsr-356。(笔记基于Tomcat8.5.15)</p>
<a id="more"></a>
<p>实现包：        </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<h4 id="1-Tomcat-启动注册WebSocket相关服务流程"><a href="#1-Tomcat-启动注册WebSocket相关服务流程" class="headerlink" title="1. Tomcat 启动注册WebSocket相关服务流程"></a>1. Tomcat 启动注册WebSocket相关服务流程</h4><p>Servlet3.0之后，加入了<code>javax.servlet.ServletContainerInitializer</code> , 在Tomcat启动时会从<code>META-INF/services/javax.servlet.ServletContainerInitializer</code>下加载该文件里面配置的类（通过Java标准的ServerLoader）。</p>
<p>打开该文件发现里面配置的是<code>org.apache.tomcat.websocket.server.WsSci</code> ,所以Tomcat会在容器初始化时加载该类</p>
<blockquote>
<p>WsSci.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Registers an interest in any class that is annotated with</div><div class="line"> * &#123;<span class="doctag">@link</span> ServerEndpoint&#125; so that Endpoint can be published via the WebSocket</div><div class="line"> * server.</div><div class="line"> */</div><div class="line"><span class="meta">@HandlesTypes</span>(&#123;ServerEndpoint.class, ServerApplicationConfig.class,</div><div class="line">        Endpoint.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsSci</span> <span class="keyword">implements</span> <span class="title">ServletContainerInitializer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//clazzes是被@HandleTypes指定的所有class，也就是所有的ServerEndpoint，ServerApplicationConfig和Endpoint </span></div><div class="line">    <span class="comment">//都会被放入到clazzes集合中</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; clazzes, ServletContext ctx)</span></span></div><div class="line">            <span class="keyword">throws</span> ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">//构建WebSocketServerContailner,</span></div><div class="line">        WsServerContainer sc = init(ctx, <span class="keyword">true</span>);</div><div class="line">		<span class="comment">//如果classez是Empty的话，说明一个WebSocket都没找到，直接返回</span></div><div class="line">        <span class="keyword">if</span> (clazzes == <span class="keyword">null</span> || clazzes.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">      </div><div class="line">      	<span class="comment">//下面的所做的事，就是找到所有Endpoint和ServerEndpoint，传入到找到的ServerApplicationConfig中，过滤出想要的端口类</span></div><div class="line"></div><div class="line">        <span class="comment">// Group the discovered classes by type</span></div><div class="line">        Set&lt;ServerApplicationConfig&gt; serverApplicationConfigs = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        Set&lt;Class&lt;? extends Endpoint&gt;&gt; scannedEndpointClazzes = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; scannedPojoEndpoints = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// wsPackage is "javax.websocket."</span></div><div class="line">            String wsPackage = ContainerProvider.class.getName();</div><div class="line">            wsPackage = wsPackage.substring(<span class="number">0</span>, wsPackage.lastIndexOf(<span class="string">'.'</span>) + <span class="number">1</span>);</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; clazz : clazzes) &#123;</div><div class="line">                <span class="keyword">int</span> modifiers = clazz.getModifiers();</div><div class="line">                <span class="keyword">if</span> (!Modifier.isPublic(modifiers) ||</div><div class="line">                        Modifier.isAbstract(modifiers)) &#123;</div><div class="line">                    <span class="comment">// Non-public or abstract - skip it.</span></div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Protect against scanning the WebSocket API JARs</span></div><div class="line">                <span class="keyword">if</span> (clazz.getName().startsWith(wsPackage)) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (ServerApplicationConfig.class.isAssignableFrom(clazz)) &#123;</div><div class="line">                    serverApplicationConfigs.add(</div><div class="line">                            (ServerApplicationConfig) clazz.newInstance());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (Endpoint.class.isAssignableFrom(clazz)) &#123;</div><div class="line">                    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                    Class&lt;? extends Endpoint&gt; endpoint =</div><div class="line">                            (Class&lt;? extends Endpoint&gt;) clazz;</div><div class="line">                    scannedEndpointClazzes.add(endpoint);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (clazz.isAnnotationPresent(ServerEndpoint.class)) &#123;</div><div class="line">                    scannedPojoEndpoints.add(clazz);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Filter the results</span></div><div class="line">        Set&lt;ServerEndpointConfig&gt; filteredEndpointConfigs = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; filteredPojoEndpoints = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (serverApplicationConfigs.isEmpty()) &#123;</div><div class="line">            filteredPojoEndpoints.addAll(scannedPojoEndpoints);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (ServerApplicationConfig config : serverApplicationConfigs) &#123;</div><div class="line">                Set&lt;ServerEndpointConfig&gt; configFilteredEndpoints =</div><div class="line">                        config.getEndpointConfigs(scannedEndpointClazzes);</div><div class="line">                <span class="keyword">if</span> (configFilteredEndpoints != <span class="keyword">null</span>) &#123;</div><div class="line">                    filteredEndpointConfigs.addAll(configFilteredEndpoints);</div><div class="line">                &#125;</div><div class="line">                Set&lt;Class&lt;?&gt;&gt; configFilteredPojos =</div><div class="line">                        config.getAnnotatedEndpointClasses(</div><div class="line">                                scannedPojoEndpoints);</div><div class="line">                <span class="keyword">if</span> (configFilteredPojos != <span class="keyword">null</span>) &#123;</div><div class="line">                    filteredPojoEndpoints.addAll(configFilteredPojos);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Deploy endpoints</span></div><div class="line">            <span class="keyword">for</span> (ServerEndpointConfig config : filteredEndpointConfigs) &#123;</div><div class="line">                sc.addEndpoint(config);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Deploy POJOs</span></div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; clazz : filteredPojoEndpoints) &#123;</div><div class="line">                sc.addEndpoint(clazz);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (DeploymentException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> WsServerContainer <span class="title">init</span><span class="params">(ServletContext servletContext,</span></span></div><div class="line">            <span class="keyword">boolean</span> initBySciMechanism) &#123;</div><div class="line">		<span class="comment">//WsServerContainer 是WebSocket协议主要实现类，负责端口的配置，链接以及数据传输</span></div><div class="line">      	<span class="comment">//需要注意的是在WsServerContainer的构造函数中会在ServletContext中注册一个WsFilter，拦截所有的请求(/*),这个filter会将Http的请求升级为WebSocket的请求</span></div><div class="line">        WsServerContainer sc = <span class="keyword">new</span> WsServerContainer(servletContext);</div><div class="line">      	<span class="comment">//将WebSocket容器放到Servlet上下文中</span></div><div class="line">        servletContext.setAttribute(</div><div class="line">                Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE, sc);</div><div class="line">		<span class="comment">//添加WsSessionListener,监听http session关闭时，关闭WebSocket Session</span></div><div class="line">        servletContext.addListener(<span class="keyword">new</span> WsSessionListener(sc));</div><div class="line">        <span class="comment">// Can't register the ContextListener again if the ContextListener is</span></div><div class="line">        <span class="comment">// calling this method</span></div><div class="line">        <span class="comment">//如果是通过配置WsContextListener注册WebSocketServerContainer（不是WsSci），则不能重复register这个监听器</span></div><div class="line">        <span class="keyword">if</span> (initBySciMechanism) &#123;</div><div class="line">          <span class="comment">//添加WsContextListener（是ServletContextListener子类），</span></div><div class="line">            servletContext.addListener(<span class="keyword">new</span> WsContextListener());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sc;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>WsContextListerner.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * In normal usage, this &#123;<span class="doctag">@link</span> ServletContextListener&#125; does not need to be</div><div class="line"> * explicitly configured as the &#123;<span class="doctag">@link</span> WsSci&#125; performs all the necessary</div><div class="line"> * bootstrap and installs this listener in the &#123;<span class="doctag">@link</span> ServletContext&#125;. If the</div><div class="line"> * &#123;<span class="doctag">@link</span> WsSci&#125; is disabled, this listener must be added manually to every</div><div class="line"> * &#123;<span class="doctag">@link</span> ServletContext&#125; that uses WebSocket to bootstrap the</div><div class="line"> * &#123;<span class="doctag">@link</span> WsServerContainer&#125; correctly.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsContextListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        ServletContext sc = sce.getServletContext();</div><div class="line">        <span class="comment">// Don't trigger WebSocket initialization if a WebSocket Server</span></div><div class="line">        <span class="comment">// Container is already present</span></div><div class="line">        <span class="keyword">if</span> (sc.getAttribute(Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE) == <span class="keyword">null</span>) &#123;</div><div class="line">            WsSci.init(sce.getServletContext(), <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        ServletContext sc = sce.getServletContext();</div><div class="line">        Object obj = sc.getAttribute(Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE);</div><div class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> WsServerContainer) &#123;</div><div class="line">            ((WsServerContainer) obj).destroy();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>ExsamplesConfig.java  过滤WebSocket端口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExamplesConfig</span> <span class="keyword">implements</span> <span class="title">ServerApplicationConfig</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ServerEndpointConfig&gt; <span class="title">getEndpointConfigs</span><span class="params">(Set&lt;Class&lt;? extends Endpoint&gt;&gt; scanned)</span> </span>&#123;</div><div class="line"></div><div class="line">        Set&lt;ServerEndpointConfig&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line"></div><div class="line">        ServerEndpointConfig config = ServerEndpointConfig.Builder.create(DmxLogServerEndpoint.class, <span class="string">"/dmxlog/&#123;loggerName&#125;"</span>).build();</div><div class="line"></div><div class="line">        result.add(config);</div><div class="line"></div><div class="line">        <span class="comment">/*if (scanned.contains(EchoEndpoint.class)) &#123;</span></div><div class="line">            result.add(ServerEndpointConfig.Builder.create(</div><div class="line">                    EchoEndpoint.class,</div><div class="line">                    "/websocket/echoProgrammatic").build());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (scanned.contains(DrawboardEndpoint.class)) &#123;</div><div class="line">            result.add(ServerEndpointConfig.Builder.create(</div><div class="line">                    DrawboardEndpoint.class,</div><div class="line">                    "/websocket/drawboard").build());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println("load servr endpoint config:" + scanned.size());</div><div class="line"></div><div class="line">*/</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Set&lt;Class&lt;?&gt;&gt; getAnnotatedEndpointClasses(Set&lt;Class&lt;?&gt;&gt; scanned) &#123;</div><div class="line">        <span class="comment">// Deploy all WebSocket endpoints defined by annotations in the examples</span></div><div class="line">        <span class="comment">// web application. Filter out all others to avoid issues when running</span></div><div class="line">        <span class="comment">// tests on Gump</span></div><div class="line">        Set&lt;Class&lt;?&gt;&gt; results = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"><span class="comment">//        for (Class&lt;?&gt; clazz : scanned) &#123;</span></div><div class="line"><span class="comment">//            if (clazz.getPackage().getName().startsWith("com.traitswu.")) &#123;</span></div><div class="line"><span class="comment">//                results.add(clazz);</span></div><div class="line"><span class="comment">//            &#125;</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line"><span class="comment">//        System.out.println("load Annotated servr endpoint config:" + scanned.size());</span></div><div class="line"><span class="comment">//        results.forEach(r -&gt; System.out.println(r.getName()));</span></div><div class="line"></div><div class="line"><span class="comment">//        results.add(DmxLogEndpoint.class);</span></div><div class="line">        <span class="keyword">return</span> results;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>总的来说，Tomcat在启动时会注册一个拦截<code>/*</code>的<code>WsFilter</code>，一个WsSessionListener以及生成一个<code>WsServerContainer</code>对象并将其放在ServletContext中。</p>
<hr>
<h4 id="2-请求流程处理"><a href="#2-请求流程处理" class="headerlink" title="2. 请求流程处理"></a>2. 请求流程处理</h4><p>首先客户端发起握手请求(通过Http协议):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /test-websocket/dmxlog/dmxLog.action1 HTTP/1.1</div><div class="line">Host: localhost:8080</div><div class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:54.0) Gecko/20100101 Firefox/54.0</div><div class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</div><div class="line">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line">Sec-WebSocket-Version: 13</div><div class="line">Origin: http://localhost:8080</div><div class="line">Sec-WebSocket-Extensions: permessage-deflate</div><div class="line">Sec-WebSocket-Key: fv9gVUx98u1+PPjGBVNk7g==</div><div class="line">Cookie: Hm_lvt_fd459238242776d173cdc64918fb32f2=1497882408,1497969850,1498035652,1498059433</div><div class="line">Connection: keep-alive, Upgrade</div><div class="line">Pragma: no-cache</div><div class="line">Cache-Control: no-cache</div><div class="line">Upgrade: websocket</div></pre></td></tr></table></figure>
<p>该请求会被<code>WsFilter</code>拦截</p>
<blockquote>
<p>WsFilter.java  该过滤器会判断，如果是WebSocket升级请求则会进行请求升级，否则当Http 普通请求处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> WsServerContainer sc;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">        sc = (WsServerContainer) filterConfig.getServletContext().getAttribute(</div><div class="line">                Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></div><div class="line">            FilterChain chain) <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// This filter only needs to handle WebSocket upgrade requests</span></div><div class="line">      	<span class="comment">//该过滤器仅仅只对是WebSocket请求做升级处理，只有在服务端有注册了的EndPoint，并且request是WebSocket请求才做升级处理。</span></div><div class="line">       <span class="comment">//而判断是否是WebSocket请求，以及升级request都是由UpgradeUtil完成</span></div><div class="line">        <span class="keyword">if</span> (!sc.areEndpointsRegistered() ||</div><div class="line">                !UpgradeUtil.isWebSocketUpgradeRequest(request, response)) &#123;</div><div class="line">            chain.doFilter(request, response);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// HTTP request with an upgrade header for WebSocket present</span></div><div class="line">        HttpServletRequest req = (HttpServletRequest) request;</div><div class="line">        HttpServletResponse resp = (HttpServletResponse) response;</div><div class="line"></div><div class="line">        <span class="comment">// Check to see if this WebSocket implementation has a matching mapping</span></div><div class="line">        String path;</div><div class="line">        String pathInfo = req.getPathInfo();</div><div class="line">        <span class="keyword">if</span> (pathInfo == <span class="keyword">null</span>) &#123;</div><div class="line">            path = req.getServletPath();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            path = req.getServletPath() + pathInfo;</div><div class="line">        &#125;</div><div class="line">      <span class="comment">// 查找是否有该请求对应的Endpoint</span></div><div class="line">        WsMappingResult mappingResult = sc.findMapping(path);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mappingResult == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// No endpoint registered for the requested path. Let the</span></div><div class="line">            <span class="comment">// application handle it (it might redirect or forward for example)</span></div><div class="line">            chain.doFilter(request, response);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">      <span class="comment">//请求升级</span></div><div class="line">        UpgradeUtil.doUpgrade(sc, req, resp, mappingResult.getConfig(),</div><div class="line">                mappingResult.getPathParams());</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// NO-OP</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">---------------------------------------------------------------------------------------------</div><div class="line"><span class="comment">/** UpgrateUtil.java</span></div><div class="line">  * </div><div class="line">  * 如果RequestMethod是"GET", 并且请求头中包含"Upgrade：websocket"，则认为客户端发起的是WebSocket升级请求 </div><div class="line">  *  </div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isWebSocketUpgradeRequest</span><span class="params">(ServletRequest request,</span></span></div><div class="line">            ServletResponse response) &#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</div><div class="line">          (response <span class="keyword">instanceof</span> HttpServletResponse) &amp;&amp;</div><div class="line">          headerContainsToken((HttpServletRequest) request,</div><div class="line">                              Constants.UPGRADE_HEADER_NAME,</div><div class="line">                              Constants.UPGRADE_HEADER_VALUE) &amp;&amp;</div><div class="line">          <span class="string">"GET"</span>.equals(((HttpServletRequest) request).getMethod()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Request升级处理</p>
<blockquote>
<p>UpgradeUtil.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UpgradeUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StringManager sm =</div><div class="line">            StringManager.getManager(UpgradeUtil.class.getPackage().getName());</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] WS_ACCEPT =</div><div class="line">            <span class="string">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span>.getBytes(</div><div class="line">                    StandardCharsets.ISO_8859_1);</div><div class="line">	.</div><div class="line">    .</div><div class="line">    .</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doUpgrade</span><span class="params">(WsServerContainer sc, HttpServletRequest req,</span></span></div><div class="line">            HttpServletResponse resp, ServerEndpointConfig sec,</div><div class="line">            Map&lt;String,String&gt; pathParams)</div><div class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate the rest of the headers and reject the request if that</span></div><div class="line">        <span class="comment">// validation fails</span></div><div class="line">        <span class="comment">// 要求请求头里面包含"Connection: upgrade", "Sec-WebSocket-Version: 13"</span></div><div class="line">        <span class="comment">// 以及 "Sec-WebSocket-Key", 否则认为是不合法的升级请求</span></div><div class="line">        <span class="comment">// WebSocket statu code: https://tools.ietf.org/html/rfc6455#section-7.4.1</span></div><div class="line">        String key;</div><div class="line">        String subProtocol = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (!headerContainsToken(req, Constants.CONNECTION_HEADER_NAME,</div><div class="line">                Constants.CONNECTION_HEADER_VALUE)) &#123;</div><div class="line">            resp.sendError(HttpServletResponse.SC_BAD_REQUEST);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!headerContainsToken(req, Constants.WS_VERSION_HEADER_NAME,</div><div class="line">                Constants.WS_VERSION_HEADER_VALUE)) &#123;</div><div class="line">            resp.setStatus(<span class="number">426</span>);</div><div class="line">            resp.setHeader(Constants.WS_VERSION_HEADER_NAME,</div><div class="line">                    Constants.WS_VERSION_HEADER_VALUE);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        key = req.getHeader(Constants.WS_KEY_HEADER_NAME);</div><div class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">            resp.sendError(HttpServletResponse.SC_BAD_REQUEST);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// Origin check  检查头字段"Origin", 用于控制可以被访问的client ip</span></div><div class="line">        String origin = req.getHeader(Constants.ORIGIN_HEADER_NAME);</div><div class="line">        <span class="keyword">if</span> (!sec.getConfigurator().checkOrigin(origin)) &#123;</div><div class="line">            resp.sendError(HttpServletResponse.SC_FORBIDDEN);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Sub-protocols 获取"Sec-WebSocket-Protocol"协议，检查是否是支持的协议</span></div><div class="line">        List&lt;String&gt; subProtocols = getTokensFromHeader(req,</div><div class="line">                Constants.WS_PROTOCOL_HEADER_NAME);</div><div class="line">        subProtocol = sec.getConfigurator().getNegotiatedSubprotocol(</div><div class="line">                sec.getSubprotocols(), subProtocols);</div><div class="line"></div><div class="line">        <span class="comment">// Extensions  这部分后面分析</span></div><div class="line">        <span class="comment">// Should normally only be one header but handle the case of multiple</span></div><div class="line">        <span class="comment">// headers</span></div><div class="line">        List&lt;Extension&gt; extensionsRequested = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        Enumeration&lt;String&gt; extHeaders = req.getHeaders(Constants.WS_EXTENSIONS_HEADER_NAME);</div><div class="line">        <span class="keyword">while</span> (extHeaders.hasMoreElements()) &#123;</div><div class="line">            Util.parseExtensionHeader(extensionsRequested, extHeaders.nextElement());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Negotiation phase 1. By default this simply filters out the</span></div><div class="line">        <span class="comment">// extensions that the server does not support but applications could</span></div><div class="line">        <span class="comment">// use a custom configurator to do more than this.</span></div><div class="line">        List&lt;Extension&gt; installedExtensions = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (sec.getExtensions().size() == <span class="number">0</span>) &#123;</div><div class="line">            installedExtensions = Constants.INSTALLED_EXTENSIONS;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            installedExtensions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            installedExtensions.addAll(sec.getExtensions());</div><div class="line">            installedExtensions.addAll(Constants.INSTALLED_EXTENSIONS);</div><div class="line">        &#125;</div><div class="line">        List&lt;Extension&gt; negotiatedExtensionsPhase1 = sec.getConfigurator().getNegotiatedExtensions(</div><div class="line">                installedExtensions, extensionsRequested);</div><div class="line"></div><div class="line">        <span class="comment">// Negotiation phase 2. Create the Transformations that will be applied</span></div><div class="line">        <span class="comment">// to this connection. Note than an extension may be dropped at this</span></div><div class="line">        <span class="comment">// point if the client has requested a configuration that the server is</span></div><div class="line">        <span class="comment">// unable to support.</span></div><div class="line">        List&lt;Transformation&gt; transformations = createTransformations(negotiatedExtensionsPhase1);</div><div class="line"></div><div class="line">        List&lt;Extension&gt; negotiatedExtensionsPhase2;</div><div class="line">        <span class="keyword">if</span> (transformations.isEmpty()) &#123;</div><div class="line">            negotiatedExtensionsPhase2 = Collections.emptyList();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            negotiatedExtensionsPhase2 = <span class="keyword">new</span> ArrayList&lt;&gt;(transformations.size());</div><div class="line">            <span class="keyword">for</span> (Transformation t : transformations) &#123;</div><div class="line">                negotiatedExtensionsPhase2.add(t.getExtensionResponse());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Build the transformation pipeline</span></div><div class="line">        Transformation transformation = <span class="keyword">null</span>;</div><div class="line">        StringBuilder responseHeaderExtensions = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">for</span> (Transformation t : transformations) &#123;</div><div class="line">            <span class="keyword">if</span> (first) &#123;</div><div class="line">                first = <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                responseHeaderExtensions.append(<span class="string">','</span>);</div><div class="line">            &#125;</div><div class="line">            append(responseHeaderExtensions, t.getExtensionResponse());</div><div class="line">            <span class="keyword">if</span> (transformation == <span class="keyword">null</span>) &#123;</div><div class="line">                transformation = t;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                transformation.setNext(t);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Now we have the full pipeline, validate the use of the RSV bits.</span></div><div class="line">        <span class="keyword">if</span> (transformation != <span class="keyword">null</span> &amp;&amp; !transformation.validateRsvBits(<span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"upgradeUtil.incompatibleRsv"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If we got this far, all is good. Accept the connection.</span></div><div class="line">        resp.setHeader(Constants.UPGRADE_HEADER_NAME,</div><div class="line">                Constants.UPGRADE_HEADER_VALUE);</div><div class="line">        resp.setHeader(Constants.CONNECTION_HEADER_NAME,</div><div class="line">                Constants.CONNECTION_HEADER_VALUE);</div><div class="line">        resp.setHeader(HandshakeResponse.SEC_WEBSOCKET_ACCEPT,</div><div class="line">                getWebSocketAccept(key));</div><div class="line">        <span class="keyword">if</span> (subProtocol != <span class="keyword">null</span> &amp;&amp; subProtocol.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// RFC6455 4.2.2 explicitly states "" is not valid here</span></div><div class="line">            resp.setHeader(Constants.WS_PROTOCOL_HEADER_NAME, subProtocol);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!transformations.isEmpty()) &#123;</div><div class="line">            resp.setHeader(Constants.WS_EXTENSIONS_HEADER_NAME, responseHeaderExtensions.toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        WsHandshakeRequest wsRequest = <span class="keyword">new</span> WsHandshakeRequest(req, pathParams);</div><div class="line">        WsHandshakeResponse wsResponse = <span class="keyword">new</span> WsHandshakeResponse();</div><div class="line">        WsPerSessionServerEndpointConfig perSessionServerEndpointConfig =</div><div class="line">                <span class="keyword">new</span> WsPerSessionServerEndpointConfig(sec);</div><div class="line">        sec.getConfigurator().modifyHandshake(perSessionServerEndpointConfig,</div><div class="line">                wsRequest, wsResponse);</div><div class="line">        wsRequest.finished();</div><div class="line"></div><div class="line">        <span class="comment">// Add any additional headers</span></div><div class="line">        <span class="keyword">for</span> (Entry&lt;String,List&lt;String&gt;&gt; entry :</div><div class="line">                wsResponse.getHeaders().entrySet()) &#123;</div><div class="line">            <span class="keyword">for</span> (String headerValue: entry.getValue()) &#123;</div><div class="line">                resp.addHeader(entry.getKey(), headerValue);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Endpoint ep;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; clazz = sec.getEndpointClass();</div><div class="line">            <span class="keyword">if</span> (Endpoint.class.isAssignableFrom(clazz)) &#123;</div><div class="line">                ep = (Endpoint) sec.getConfigurator().getEndpointInstance(</div><div class="line">                        clazz);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ep = <span class="keyword">new</span> PojoEndpointServer();</div><div class="line">                <span class="comment">// Need to make path params available to POJO</span></div><div class="line">                perSessionServerEndpointConfig.getUserProperties().put(</div><div class="line">                        org.apache.tomcat.websocket.pojo.Constants.POJO_PATH_PARAM_KEY, pathParams);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        WsHttpUpgradeHandler wsHandler =</div><div class="line">                req.upgrade(WsHttpUpgradeHandler.class);</div><div class="line">        wsHandler.preInit(ep, perSessionServerEndpointConfig, sc, wsRequest,</div><div class="line">                negotiatedExtensionsPhase2, subProtocol, transformation, pathParams,</div><div class="line">                req.isSecure());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Transformation&gt; <span class="title">createTransformations</span><span class="params">(</span></span></div><div class="line">            List&lt;Extension&gt; negotiatedExtensions) &#123;</div><div class="line"></div><div class="line">        TransformationFactory factory = TransformationFactory.getInstance();</div><div class="line"></div><div class="line">        LinkedHashMap&lt;String,List&lt;List&lt;Extension.Parameter&gt;&gt;&gt; extensionPreferences =</div><div class="line">                <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// Result will likely be smaller than this</span></div><div class="line">        List&lt;Transformation&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(negotiatedExtensions.size());</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Extension extension : negotiatedExtensions) &#123;</div><div class="line">            List&lt;List&lt;Extension.Parameter&gt;&gt; preferences =</div><div class="line">                    extensionPreferences.get(extension.getName());</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (preferences == <span class="keyword">null</span>) &#123;</div><div class="line">                preferences = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                extensionPreferences.put(extension.getName(), preferences);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            preferences.add(extension.getParameters());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String,List&lt;List&lt;Extension.Parameter&gt;&gt;&gt; entry :</div><div class="line">            extensionPreferences.entrySet()) &#123;</div><div class="line">            Transformation transformation = factory.create(entry.getKey(), entry.getValue(), <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">if</span> (transformation != <span class="keyword">null</span>) &#123;</div><div class="line">                result.add(transformation);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getWebSocketAccept</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] digest = ConcurrentMessageDigest.digestSHA1(</div><div class="line">                key.getBytes(StandardCharsets.ISO_8859_1), WS_ACCEPT);</div><div class="line">        <span class="keyword">return</span> Base64.encodeBase64String(digest);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>待续</p>
<ol>
<li>如何升级</li>
<li>如何建立链接</li>
</ol>
</blockquote>

    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            <a class="cat-link" href="/categories/WebSocket/">WebSocket</a>
        </span>
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/websocket/" title="websocket">websocket</a>
    

        </span>
    </p>
</article>
<div class="article-share clearfix text-center">
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</div>

<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br >
        <a href="/2017/07/05/lucene/firstdemo/">
            
                Lucene Hello World
            
        </a>
    </span>
    

    
    <span class="next fr">
        下一篇<br >
        <a href="/2017/06/18/Websocket Summarize/">
            
                WebSocket 笔记
            
        </a>
    </span>
    
</div>

<!-- 文章评论 -->

            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/WebSocket/">WebSocket</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="/categories/MyBatis/">MyBatis</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/lucene/">lucene</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/JavaSE/">JavaSE</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/websocket/" title="websocket">websocket (3)</a>
  
    <a class="tag-item" href="/tags/Mybatis-入门/" title="Mybatis 入门">Mybatis 入门 (1)</a>
  
    <a class="tag-item" href="/tags/lucene/" title="lucene">lucene (1)</a>
  
    <a class="tag-item" href="/tags/JavaSE/" title="JavaSE">JavaSE (1)</a>
  
    <a class="tag-item" href="/tags/并发/" title="并发">并发 (1)</a>
  
    <a class="tag-item" href="/tags/CompletableFuture/" title="CompletableFuture">CompletableFuture (1)</a>
  
</div>
    </section>
    

    
    <!-- 我的微博 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>我的微博</strong></h3>
        <div class="widget-bd" style="position: relative;">
  <div id="myWeiboLoading" class="text-center" style="position:absolute;top:0;left:0;right:0;bottom:0;line-height:50px;font-size:12px;background-color:#fff;z-index:9;">微博加载中...</div>
  <iframe id="myWeibo" width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=4&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=2433664154&verifier=66842d60&dpc=1"></iframe>
  <script>
  (function () {
    var oMyWeibo = document.getElementById('myWeibo');
    var oMyWeiboLoading = document.getElementById('myWeiboLoading');
    var isIE = /msie/i.test(navigator.userAgent) && !window.opera;
    var timer = null;
    if (isIE) {
      oMyWeibo.onreadystatechange = function(){
        if(oMyWeibo.readyState === 'loaded' || oMyWeibo.readyState === 'complete'){
          timer = setTimeout(function () {
            oMyWeiboLoading.parentNode.removeChild(oMyWeiboLoading);
            timer = null;
          }, 300);
        }
      };
    } else {
      oMyWeibo.onload = function () {
        timer = setTimeout(function () {
          oMyWeiboLoading.parentNode.removeChild(oMyWeiboLoading);
          timer = null;
        }, 300);
      };
    }
  })();
  </script>
</div>
    </section>
    

    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2017
    

    <a href="/">鄂ICP备15016859号-1</a>
    
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>
<!-- 添加百度自动推送 -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>

</body>
</html>