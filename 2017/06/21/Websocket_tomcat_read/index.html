<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>WebSocket Tomcat实现 | Quan Blogs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="wuquan" >
    <meta name="description" content="Quan个人前端小站" >

    
    <link rel="alternative" href="/atom.xml" title="Quan Blogs" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="/favicon.ico" >
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?fd459238242776d173cdc64918fb32f2";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


    
</head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">Quan Blogs</span>
                    <span class="description">Quan</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/lab/" title="计划" class="icon-lab">&nbsp;计划</a>
            </li>
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/2017/06/21/Websocket_tomcat_read/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="“#”" target="_blank">Coding</a>
                        |
                    
                        <a href="#" target="_blank">Github</a>
                        |
                    
                        <a href="#" target="_blank">百度统计</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com/" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_quan.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span>WebSocket Tomcat实现</span></h3>
    </header>
    <p class="post-meta text-center">
        Quan 发表于
        <time datetime="2017-06-21T09:05:10.400Z">2017-06-21</time>
    </p>
    <div class="post-content">
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Tomcat8真正支持jsr-356(包含对websocket的支持)， tomcat7部分版本的websocket实现不兼容jsr-356。(笔记基于Tomcat8.5.15)</p>
<a id="more"></a>
<p>实现包：        </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<h4 id="1-Tomcat-启动注册WebSocket相关服务流程"><a href="#1-Tomcat-启动注册WebSocket相关服务流程" class="headerlink" title="1. Tomcat 启动注册WebSocket相关服务流程"></a>1. Tomcat 启动注册WebSocket相关服务流程</h4><p>Servlet3.0之后，加入了<code>javax.servlet.ServletContainerInitializer</code> , 在Tomcat启动时会从<code>META-INF/services/javax.servlet.ServletContainerInitializer</code>下加载该文件里面配置的类（通过Java标准的ServerLoader）。</p>
<p>打开该文件发现里面配置的是<code>org.apache.tomcat.websocket.server.WsSci</code> ,所以Tomcat会在容器初始化时加载该类</p>
<blockquote>
<p>WsSci.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Registers an interest in any class that is annotated with</div><div class="line"> * &#123;<span class="doctag">@link</span> ServerEndpoint&#125; so that Endpoint can be published via the WebSocket</div><div class="line"> * server.</div><div class="line"> */</div><div class="line"><span class="meta">@HandlesTypes</span>(&#123;ServerEndpoint.class, ServerApplicationConfig.class,</div><div class="line">        Endpoint.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsSci</span> <span class="keyword">implements</span> <span class="title">ServletContainerInitializer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//clazzes是被@HandleTypes指定的所有class，也就是所有的ServerEndpoint，ServerApplicationConfig和Endpoint </span></div><div class="line">    <span class="comment">//都会被放入到clazzes集合中</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; clazzes, ServletContext ctx)</span></span></div><div class="line">            <span class="keyword">throws</span> ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">//构建WebSocketServerContailner,</span></div><div class="line">        WsServerContainer sc = init(ctx, <span class="keyword">true</span>);</div><div class="line">		<span class="comment">//如果classez是Empty的话，说明一个WebSocket都没找到，直接返回</span></div><div class="line">        <span class="keyword">if</span> (clazzes == <span class="keyword">null</span> || clazzes.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">      </div><div class="line">      	<span class="comment">//下面的所做的事，就是找到所有Endpoint和ServerEndpoint，传入到找到的ServerApplicationConfig中，过滤出想要的端口类</span></div><div class="line"></div><div class="line">        <span class="comment">// Group the discovered classes by type</span></div><div class="line">        Set&lt;ServerApplicationConfig&gt; serverApplicationConfigs = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        Set&lt;Class&lt;? extends Endpoint&gt;&gt; scannedEndpointClazzes = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; scannedPojoEndpoints = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// wsPackage is "javax.websocket."</span></div><div class="line">            String wsPackage = ContainerProvider.class.getName();</div><div class="line">            wsPackage = wsPackage.substring(<span class="number">0</span>, wsPackage.lastIndexOf(<span class="string">'.'</span>) + <span class="number">1</span>);</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; clazz : clazzes) &#123;</div><div class="line">                <span class="keyword">int</span> modifiers = clazz.getModifiers();</div><div class="line">                <span class="keyword">if</span> (!Modifier.isPublic(modifiers) ||</div><div class="line">                        Modifier.isAbstract(modifiers)) &#123;</div><div class="line">                    <span class="comment">// Non-public or abstract - skip it.</span></div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Protect against scanning the WebSocket API JARs</span></div><div class="line">                <span class="keyword">if</span> (clazz.getName().startsWith(wsPackage)) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (ServerApplicationConfig.class.isAssignableFrom(clazz)) &#123;</div><div class="line">                    serverApplicationConfigs.add(</div><div class="line">                            (ServerApplicationConfig) clazz.newInstance());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (Endpoint.class.isAssignableFrom(clazz)) &#123;</div><div class="line">                    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                    Class&lt;? extends Endpoint&gt; endpoint =</div><div class="line">                            (Class&lt;? extends Endpoint&gt;) clazz;</div><div class="line">                    scannedEndpointClazzes.add(endpoint);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (clazz.isAnnotationPresent(ServerEndpoint.class)) &#123;</div><div class="line">                    scannedPojoEndpoints.add(clazz);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Filter the results</span></div><div class="line">        Set&lt;ServerEndpointConfig&gt; filteredEndpointConfigs = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; filteredPojoEndpoints = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (serverApplicationConfigs.isEmpty()) &#123;</div><div class="line">            filteredPojoEndpoints.addAll(scannedPojoEndpoints);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (ServerApplicationConfig config : serverApplicationConfigs) &#123;</div><div class="line">                Set&lt;ServerEndpointConfig&gt; configFilteredEndpoints =</div><div class="line">                        config.getEndpointConfigs(scannedEndpointClazzes);</div><div class="line">                <span class="keyword">if</span> (configFilteredEndpoints != <span class="keyword">null</span>) &#123;</div><div class="line">                    filteredEndpointConfigs.addAll(configFilteredEndpoints);</div><div class="line">                &#125;</div><div class="line">                Set&lt;Class&lt;?&gt;&gt; configFilteredPojos =</div><div class="line">                        config.getAnnotatedEndpointClasses(</div><div class="line">                                scannedPojoEndpoints);</div><div class="line">                <span class="keyword">if</span> (configFilteredPojos != <span class="keyword">null</span>) &#123;</div><div class="line">                    filteredPojoEndpoints.addAll(configFilteredPojos);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Deploy endpoints</span></div><div class="line">            <span class="keyword">for</span> (ServerEndpointConfig config : filteredEndpointConfigs) &#123;</div><div class="line">                sc.addEndpoint(config);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Deploy POJOs</span></div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; clazz : filteredPojoEndpoints) &#123;</div><div class="line">                sc.addEndpoint(clazz);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (DeploymentException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> WsServerContainer <span class="title">init</span><span class="params">(ServletContext servletContext,</span></span></div><div class="line">            <span class="keyword">boolean</span> initBySciMechanism) &#123;</div><div class="line">		<span class="comment">//WsServerContainer 是WebSocket协议主要实现类，负责端口的配置，链接以及数据传输</span></div><div class="line">      	<span class="comment">//需要注意的是在WsServerContainer的构造函数中会在ServletContext中注册一个WsFilter，拦截所有的请求(/*),这个filter会将Http的请求升级为WebSocket的请求</span></div><div class="line">        WsServerContainer sc = <span class="keyword">new</span> WsServerContainer(servletContext);</div><div class="line">      	<span class="comment">//将WebSocket容器放到Servlet上下文中</span></div><div class="line">        servletContext.setAttribute(</div><div class="line">                Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE, sc);</div><div class="line">		<span class="comment">//添加WsSessionListener,监听http session关闭时，关闭WebSocket Session</span></div><div class="line">        servletContext.addListener(<span class="keyword">new</span> WsSessionListener(sc));</div><div class="line">        <span class="comment">// Can't register the ContextListener again if the ContextListener is</span></div><div class="line">        <span class="comment">// calling this method</span></div><div class="line">        <span class="comment">//如果是通过配置WsContextListener注册WebSocketServerContainer（不是WsSci），则不能重复register这个监听器</span></div><div class="line">        <span class="keyword">if</span> (initBySciMechanism) &#123;</div><div class="line">          <span class="comment">//添加WsContextListener（是ServletContextListener子类），</span></div><div class="line">            servletContext.addListener(<span class="keyword">new</span> WsContextListener());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sc;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>WsContextListerner.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * In normal usage, this &#123;<span class="doctag">@link</span> ServletContextListener&#125; does not need to be</div><div class="line"> * explicitly configured as the &#123;<span class="doctag">@link</span> WsSci&#125; performs all the necessary</div><div class="line"> * bootstrap and installs this listener in the &#123;<span class="doctag">@link</span> ServletContext&#125;. If the</div><div class="line"> * &#123;<span class="doctag">@link</span> WsSci&#125; is disabled, this listener must be added manually to every</div><div class="line"> * &#123;<span class="doctag">@link</span> ServletContext&#125; that uses WebSocket to bootstrap the</div><div class="line"> * &#123;<span class="doctag">@link</span> WsServerContainer&#125; correctly.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsContextListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        ServletContext sc = sce.getServletContext();</div><div class="line">        <span class="comment">// Don't trigger WebSocket initialization if a WebSocket Server</span></div><div class="line">        <span class="comment">// Container is already present</span></div><div class="line">        <span class="keyword">if</span> (sc.getAttribute(Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE) == <span class="keyword">null</span>) &#123;</div><div class="line">            WsSci.init(sce.getServletContext(), <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        ServletContext sc = sce.getServletContext();</div><div class="line">        Object obj = sc.getAttribute(Constants.SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE);</div><div class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> WsServerContainer) &#123;</div><div class="line">            ((WsServerContainer) obj).destroy();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>ExsamplesConfig.java  过滤WebSocket端口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExamplesConfig</span> <span class="keyword">implements</span> <span class="title">ServerApplicationConfig</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ServerEndpointConfig&gt; <span class="title">getEndpointConfigs</span><span class="params">(Set&lt;Class&lt;? extends Endpoint&gt;&gt; scanned)</span> </span>&#123;</div><div class="line"></div><div class="line">        Set&lt;ServerEndpointConfig&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line"></div><div class="line">        ServerEndpointConfig config = ServerEndpointConfig.Builder.create(DmxLogServerEndpoint.class, <span class="string">"/dmxlog/&#123;loggerName&#125;"</span>).build();</div><div class="line"></div><div class="line">        result.add(config);</div><div class="line"></div><div class="line">        <span class="comment">/*if (scanned.contains(EchoEndpoint.class)) &#123;</span></div><div class="line">            result.add(ServerEndpointConfig.Builder.create(</div><div class="line">                    EchoEndpoint.class,</div><div class="line">                    "/websocket/echoProgrammatic").build());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (scanned.contains(DrawboardEndpoint.class)) &#123;</div><div class="line">            result.add(ServerEndpointConfig.Builder.create(</div><div class="line">                    DrawboardEndpoint.class,</div><div class="line">                    "/websocket/drawboard").build());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println("load servr endpoint config:" + scanned.size());</div><div class="line"></div><div class="line">*/</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Set&lt;Class&lt;?&gt;&gt; getAnnotatedEndpointClasses(Set&lt;Class&lt;?&gt;&gt; scanned) &#123;</div><div class="line">        <span class="comment">// Deploy all WebSocket endpoints defined by annotations in the examples</span></div><div class="line">        <span class="comment">// web application. Filter out all others to avoid issues when running</span></div><div class="line">        <span class="comment">// tests on Gump</span></div><div class="line">        Set&lt;Class&lt;?&gt;&gt; results = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"><span class="comment">//        for (Class&lt;?&gt; clazz : scanned) &#123;</span></div><div class="line"><span class="comment">//            if (clazz.getPackage().getName().startsWith("com.traitswu.")) &#123;</span></div><div class="line"><span class="comment">//                results.add(clazz);</span></div><div class="line"><span class="comment">//            &#125;</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line"><span class="comment">//        System.out.println("load Annotated servr endpoint config:" + scanned.size());</span></div><div class="line"><span class="comment">//        results.forEach(r -&gt; System.out.println(r.getName()));</span></div><div class="line"></div><div class="line"><span class="comment">//        results.add(DmxLogEndpoint.class);</span></div><div class="line">        <span class="keyword">return</span> results;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>总的来说，Tomcat在启动时会注册一个拦截<code>/*</code>的<code>WsFilter</code>，以及生成一个<code>WsServerContainer</code>对象并将其放在ServletContext中。</p>
<hr>
<h4 id="2-请求流程处理"><a href="#2-请求流程处理" class="headerlink" title="2. 请求流程处理"></a>2. 请求流程处理</h4><blockquote>
<p>待续…</p>
</blockquote>

    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            <a class="cat-link" href="/categories/WebSocket/">WebSocket</a>
        </span>
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/webscoket/" title="webscoket">webscoket</a>
    

        </span>
    </p>
</article>
<div class="article-share clearfix text-center">
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</div>

<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br >
        <a href="javascript: void(0);">没有上一篇了</a>
    </span>
    

    
    <span class="next fr">
        下一篇<br >
        <a href="/2017/06/18/Websocket Summarize/">
            
                WebSocket 笔记
            
        </a>
    </span>
    
</div>

<!-- 文章评论 -->

            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/WebSocket/">WebSocket</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/MyBatis/">MyBatis</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/webscoket/" title="webscoket">webscoket (2)</a>
  
    <a class="tag-item" href="/tags/Mybatis-入门/" title="Mybatis 入门">Mybatis 入门 (1)</a>
  
</div>
    </section>
    

    
    <!-- 我的微博 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>我的微博</strong></h3>
        <div class="widget-bd" style="position: relative;">
  <div id="myWeiboLoading" class="text-center" style="position:absolute;top:0;left:0;right:0;bottom:0;line-height:50px;font-size:12px;background-color:#fff;z-index:9;">微博加载中...</div>
  <iframe id="myWeibo" width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=4&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=2433664154&verifier=66842d60&dpc=1"></iframe>
  <script>
  (function () {
    var oMyWeibo = document.getElementById('myWeibo');
    var oMyWeiboLoading = document.getElementById('myWeiboLoading');
    var isIE = /msie/i.test(navigator.userAgent) && !window.opera;
    var timer = null;
    if (isIE) {
      oMyWeibo.onreadystatechange = function(){
        if(oMyWeibo.readyState === 'loaded' || oMyWeibo.readyState === 'complete'){
          timer = setTimeout(function () {
            oMyWeiboLoading.parentNode.removeChild(oMyWeiboLoading);
            timer = null;
          }, 300);
        }
      };
    } else {
      oMyWeibo.onload = function () {
        timer = setTimeout(function () {
          oMyWeiboLoading.parentNode.removeChild(oMyWeiboLoading);
          timer = null;
        }, 300);
      };
    }
  })();
  </script>
</div>
    </section>
    

    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2017
    

    <a href="/">鄂ICP备15016859号-1</a>
    
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>
<!-- 添加百度自动推送 -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>

</body>
</html>